@page "/watch/{Id:int}"
@using NetTube.Models
@using NetTube.Services
@using Microsoft.AspNetCore.Components.Web
@inject VideoService VideoService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@if (Video == null)
{
    <p><em>Loading video...</em></p>
}
else
{
    <PageTitle>@Video.Title - NetTube</PageTitle>

    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 20px;">
        <div class="video-container">
            <video class="video-player" controls autoplay style="width: 100%; border-radius: 15px; background: black;">
                <source src="@Video.VideoUrl" type="video/mp4" />
                Your browser does not support the video tag.
            </video>

            <h1 style="font-size: 24px; margin: 15px 0;">@Video.Title</h1>
            
            <div class="video-actions glass-panel" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-radius: 10px;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <img src="@(Video.Uploader?.ProfilePictureUrl ?? $"https://i.pravatar.cc/150?img={Video.UserId + 10}")" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; cursor: pointer;" @onclick="() => NavigateToProfile(Video.UserId)" />
                    <div>
                        <strong style="display: block; cursor: pointer;" @onclick="() => NavigateToProfile(Video.UserId)">@Video.Uploader?.Username</strong>
                        <span style="font-size: 12px; opacity: 0.7;">@SubscriberCount subscribers</span>
                    </div>
                    @if (CurrentUserId != Video.UserId)
                    {
                        <button class="btn-primary" style="margin-left: 20px; background: @(IsSubscribed ? "var(--glass-bg)" : "var(--primary-color)");" @onclick="ToggleSubscribe">
                            @(IsSubscribed ? "Subscribed" : "Subscribe")
                        </button>
                    }
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-secondary glass-panel" style="border-radius: 20px; padding: 5px 15px; background: @(HasLiked ? "rgba(255,0,0,0.2)" : "transparent");" @onclick="ToggleLike">
                        <i class="fas fa-thumbs-up" style="color: @(HasLiked ? "var(--primary-color)" : "inherit");"></i> @(Video.Likes?.Count ?? 0)
                    </button>
                    <button class="btn-secondary glass-panel" style="border-radius: 20px; padding: 5px 15px;" @onclick="CopyLink">
                        <i class="fas fa-share"></i> Share
                    </button>
                </div>
            </div>

            <div class="video-description glass-panel" style="margin-top: 20px; padding: 15px; border-radius: 10px;">
                <div style="font-weight: bold; margin-bottom: 10px;">
                    @Video.Views views â€¢ @Video.UploadedAt.ToString("MMM dd, yyyy")
                </div>
                <p style="white-space: pre-line;">@Video.Description</p>
            </div>

            <div class="comments-section" style="margin-top: 30px;">
                <h3>Comments (@(Video.Comments?.Count ?? 0))</h3>
                <AuthorizeView Context="AuthContext">
                    <Authorized>
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start;">
                            <img src="@(AuthContext.User.FindFirst(System.Security.Claims.ClaimTypes.Uri)?.Value ?? "https://i.pravatar.cc/150?img=11")" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />
                            <div style="flex-grow: 1;">
                                <EditForm Model="newComment" OnValidSubmit="SubmitComment">
                                    <InputText @bind-Value="newComment.Content" placeholder="Add a comment..." style="width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--glass-border); color: var(--text-color); padding: 5px; outline: none;" />
                                    <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                                        <button type="submit" class="btn-primary" style="padding: 5px 15px; border-radius: 20px;" disabled="@string.IsNullOrWhiteSpace(newComment.Content)">Comment</button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <p style="opacity: 0.7;">Please <a href="/login" style="color: var(--primary-color);">sign in</a> to leave a comment.</p>
                    </NotAuthorized>
                </AuthorizeView>

                @if(Video.Comments != null)
                {
                    @foreach (var comment in Video.Comments.OrderByDescending(c => c.PostedAt))
                    {
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <img src="@(comment.User?.ProfilePictureUrl ?? $"https://i.pravatar.cc/150?img={comment.UserId + 5}")" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;" @onclick="() => NavigateToProfile(comment.UserId)" />
                            <div>
                                <span style="font-weight: bold; cursor: pointer;" @onclick="() => NavigateToProfile(comment.UserId)">@comment.User?.Username</span>
                                <span style="font-size: 12px; opacity: 0.7; margin-left: 10px;">@comment.PostedAt.ToString("g")</span>
                                <p style="margin: 5px 0;">@comment.Content</p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <div class="recommendations">
            <h4>Up next</h4>
            @if (RelatedVideos != null)
            {
                @foreach(var related in RelatedVideos)
                {
                    <div class="related-card glass-panel" style="display: flex; gap: 10px; margin-bottom: 15px; cursor: pointer;" @onclick="() => WatchRelatedVideo(related.Id)">
                        <img src="@related.ThumbnailUrl" style="width: 120px; height: 68px; object-fit: cover; border-radius: 8px;" />
                        <div style="overflow: hidden;">
                            <div style="font-weight: bold; font-size: 14px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 5px;">@related.Title</div>
                            <div style="font-size: 12px; opacity: 0.7; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">@related.Uploader?.Username</div>
                            <div style="font-size: 12px; opacity: 0.7;">@related.Views views</div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Video? Video;
    private List<Video>? RelatedVideos;
    private Comment newComment = new Comment();
    private int? CurrentUserId;
    private bool HasLiked = false;
    private bool IsSubscribed = false;
    private int SubscriberCount = 0;

    protected override async Task OnParametersSetAsync()
    {
        await LoadVideoData();
    }

    private async Task LoadVideoData()
    {
        Video = await VideoService.GetVideoByIdAsync(Id);
        
        if (Video != null)
        {
            SubscriberCount = await VideoService.GetSubscriberCountAsync(Video.UserId);
            var allVideos = await VideoService.GetAllVideosAsync();
            RelatedVideos = allVideos.Where(v => v.Id != Id && (v.Category == Video.Category || v.UserId == Video.UserId)).Take(8).ToList();
            
            // If less related, fill with random ones
            if (RelatedVideos.Count < 5)
            {
                var extra = allVideos.Where(v => v.Id != Id && !RelatedVideos.Any(rv => rv.Id == v.Id)).Take(5 - RelatedVideos.Count);
                RelatedVideos.AddRange(extra);
            }
            
            if (AuthStateProvider is CustomAuthStateProvider customAuth)
            {
                var authState = await customAuth.GetAuthenticationStateAsync();
                if (authState.User.Identity?.IsAuthenticated == true && customAuth.CurrentUserModel != null)
                {
                    CurrentUserId = customAuth.CurrentUserModel.Id;
                    
                    // Setup initial states
                    HasLiked = Video.Likes?.Any(l => l.UserId == CurrentUserId.Value) == true;
                    IsSubscribed = await VideoService.IsSubscribedAsync(CurrentUserId.Value, Video.UserId);
                    
                    // Record history
                    await VideoService.RecordHistoryAsync(CurrentUserId.Value, Video.Id);
                }
            }
            
            // Increase view locally (in a real app, this might be triggered by JS when video plays)
            Video.Views++; 
        }
    }

    private void WatchRelatedVideo(int id)
    {
        Navigation.NavigateTo($"/watch/{id}", forceLoad: true);
    }

    private void NavigateToProfile(int userId)
    {
        // Currently profile is hardcoded to logged in user. 
        // In a full app, we would pass /profile/{userId}
    }

    private async Task SubmitComment()
    {
        if (CurrentUserId.HasValue && Video != null && !string.IsNullOrWhiteSpace(newComment.Content))
        {
            newComment.UserId = CurrentUserId.Value;
            newComment.VideoId = Video.Id;
            newComment.PostedAt = DateTime.UtcNow;
            
            await VideoService.AddCommentAsync(newComment);
            
            // Refetch video to get updated comments with User object populated
            Video = await VideoService.GetVideoByIdAsync(Id);
            newComment = new Comment(); // reset input
        }
    }

    private async Task ToggleLike()
    {
        if (CurrentUserId == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        if (Video != null)
        {
            HasLiked = await VideoService.ToggleLikeAsync(CurrentUserId.Value, Video.Id);
            Video = await VideoService.GetVideoByIdAsync(Id); // Refresh to update count
        }
    }

    private async Task ToggleSubscribe()
    {
        if (CurrentUserId == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        if (Video != null)
        {
            IsSubscribed = await VideoService.ToggleSubscribeAsync(CurrentUserId.Value, Video.UserId);
            SubscriberCount = await VideoService.GetSubscriberCountAsync(Video.UserId);
        }
    }

    private async Task CopyLink()
    {
        var url = Navigation.Uri;
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", url);
        // Optional: Show a toast notification
    }
}