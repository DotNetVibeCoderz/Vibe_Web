@page "/change-password"

<PageTitle>Change Password - NetTube</PageTitle>

<div style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
    <div class="glass-panel" style="width: 100%; max-width: 400px; padding: 40px;">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: var(--primary-color); font-weight: bold;">
                <i class="fas fa-lock"></i> NetTube
            </h2>
            <p>Account Recovery</p>
            <p style="font-size: 14px; opacity: 0.8;">Enter your email to reset your password</p>
            @if (message != null)
            {
                <p style="color: @(isSuccess ? "#4caf50" : "#ff4444"); font-size: 14px; margin-top: 10px;">@message</p>
            }
        </div>

        <EditForm Model="changeModel" OnValidSubmit="HandleReset">
            <DataAnnotationsValidator />

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                <InputText @bind-Value="changeModel.Email" type="email" class="form-control glass-panel" style="width: 100%; color: var(--text-color); border: 1px solid var(--glass-border); outline: none;" />
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">New Password</label>
                <InputText @bind-Value="changeModel.NewPassword" type="password" class="form-control glass-panel" style="width: 100%; color: var(--text-color); border: 1px solid var(--glass-border); outline: none;" />
            </div>

            <button type="submit" class="btn-primary" style="width: 100%; padding: 12px; font-size: 16px; font-weight: bold;">Reset Password</button>
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="/login" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">Back to login</a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [Inject]
    public NavigationManager Navigation { get; set; } = default!;

    [Inject]
    public AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    private ChangeModel changeModel = new();
    private string? message;
    private bool isSuccess;

    private async Task HandleReset()
    {
        if (AuthStateProvider is CustomAuthStateProvider customAuth)
        {
            var result = await customAuth.ChangePasswordAsync(changeModel.Email, changeModel.NewPassword);
            if (result)
            {
                isSuccess = true;
                message = "Password has been successfully changed.";
            }
            else
            {
                isSuccess = false;
                message = "Email not found.";
            }
        }
    }

    public class ChangeModel
    {
        [System.ComponentModel.DataAnnotations.Required, System.ComponentModel.DataAnnotations.EmailAddress]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required, System.ComponentModel.DataAnnotations.MinLength(6)]
        public string NewPassword { get; set; } = string.Empty;
    }
}