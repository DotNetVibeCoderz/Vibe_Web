@page "/playlists"
@using NetTube.Models
@using NetTube.Services
@inject VideoService VideoService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Playlists - NetTube</PageTitle>

<div class="glass-panel" style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2><i class="fas fa-list"></i> Your Playlists</h2>
        <AuthorizeView>
            <Authorized>
                <div style="display: flex; gap: 10px; align-items: center;">
                    @if (IsCreating)
                    {
                        <input type="text" @bind="NewPlaylistTitle" placeholder="Playlist title..." class="form-control glass-panel" style="background: transparent; color: var(--text-color); border: 1px solid var(--glass-border);" />
                        <button class="btn-primary" style="padding: 5px 15px;" @onclick="CreatePlaylist">Save</button>
                        <button class="btn-secondary" style="background: transparent; border: none; color: var(--text-color);" @onclick="ToggleCreate">Cancel</button>
                    }
                    else
                    {
                        <button class="btn-primary" @onclick="ToggleCreate"><i class="fas fa-plus"></i> New Playlist</button>
                    }
                </div>
            </Authorized>
        </AuthorizeView>
    </div>
    
    <AuthorizeView>
        <Authorized>
            @if (UserPlaylists == null)
            {
                <p>Loading...</p>
            }
            else if (!UserPlaylists.Any())
            {
                <div style="text-align: center; padding: 40px; opacity: 0.7;">
                    <i class="fas fa-folder-open fa-3x" style="margin-bottom: 15px;"></i>
                    <p>You haven't created any playlists yet.</p>
                </div>
            }
            else
            {
                <div class="video-grid">
                    @foreach(var playlist in UserPlaylists)
                    {
                        var firstVideo = playlist.PlaylistVideos.FirstOrDefault()?.Video;
                        <div class="video-card glass-panel" style="position: relative;">
                            <div style="position: relative; cursor: pointer;" @onclick="() => GoToWatch(firstVideo?.Id)">
                                <img src="@(firstVideo?.ThumbnailUrl ?? "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&q=80")" style="width: 100%; height: 160px; object-fit: cover; border-radius: 10px; opacity: @(firstVideo == null ? "0.5" : "1");" />
                                <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 40%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; border-top-right-radius: 10px; border-bottom-right-radius: 10px; flex-direction: column;">
                                    <span style="color: white; font-weight: bold; font-size: 20px;">@playlist.PlaylistVideos.Count</span>
                                    <i class="fas fa-list" style="color: white; margin-top: 5px;"></i>
                                </div>
                            </div>
                            <div class="video-info" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <div class="video-title" style="font-weight: bold; cursor: pointer;" @onclick="() => GoToWatch(firstVideo?.Id)">@playlist.Title</div>
                                    <div class="video-meta">Updated @playlist.CreatedAt.ToString("MMM dd, yyyy")</div>
                                </div>
                                <button class="btn-secondary" style="background: transparent; border: none; color: var(--text-color); opacity: 0.5; cursor: pointer;" @onclick="() => DeletePlaylist(playlist.Id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <button class="btn-secondary glass-panel" style="width: 100%; margin-top: 10px; text-transform: uppercase; font-size: 12px; font-weight: bold;" @onclick="() => GoToWatch(firstVideo?.Id)" disabled="@(firstVideo == null)">
                                @(firstVideo == null ? "Empty Playlist" : "Play All")
                            </button>
                        </div>
                    }
                </div>
            }
        </Authorized>
        <NotAuthorized>
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-list fa-4x" style="color: var(--primary-color); margin-bottom: 20px;"></i>
                <h3>Sign in to save videos</h3>
                <p style="opacity: 0.7;">Sign in to access your saved playlists.</p>
                <a href="/login" class="btn-primary" style="text-decoration: none; display: inline-block; margin-top: 10px;">
                    <i class="fas fa-user-circle"></i> Sign In
                </a>
            </div>
        </NotAuthorized>
    </AuthorizeView>
</div>

@code {
    private List<Playlist>? UserPlaylists;
    private int CurrentUserId;
    private bool IsCreating = false;
    private string NewPlaylistTitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadPlaylists();
    }

    private async Task LoadPlaylists()
    {
        if (AuthStateProvider is CustomAuthStateProvider customAuth)
        {
            var authState = await customAuth.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true && customAuth.CurrentUserModel != null)
            {
                CurrentUserId = customAuth.CurrentUserModel.Id;
                UserPlaylists = await VideoService.GetUserPlaylistsAsync(CurrentUserId);
            }
        }
    }

    private void ToggleCreate()
    {
        IsCreating = !IsCreating;
        NewPlaylistTitle = string.Empty;
    }

    private async Task CreatePlaylist()
    {
        if (!string.IsNullOrWhiteSpace(NewPlaylistTitle) && CurrentUserId > 0)
        {
            await VideoService.CreatePlaylistAsync(CurrentUserId, NewPlaylistTitle);
            await LoadPlaylists();
            IsCreating = false;
            NewPlaylistTitle = string.Empty;
        }
    }

    private async Task DeletePlaylist(int id)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this playlist?");
        if (confirmed)
        {
            await VideoService.DeletePlaylistAsync(id);
            await LoadPlaylists();
        }
    }

    private void GoToWatch(int? videoId)
    {
        if (videoId.HasValue)
        {
            Navigation.NavigateTo($"/watch/{videoId.Value}");
        }
    }
}