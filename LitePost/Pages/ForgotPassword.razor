@page "/forgot-password"
@layout AuthLayout
@inject UserService UserService
@inject NavigationManager NavigationManager
@using System.ComponentModel.DataAnnotations
@using LitePost.Shared

<h3 class="fw-bold mb-4">Find your LitePost account</h3>

@if (!emailSent)
{
    <EditForm Model="@forgotModel" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        
        <p class="text-muted small mb-4">Enter the email associated with your account to change your password.</p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger py-2 mb-3 small">@errorMessage</div>
        }

        <div class="form-floating mb-4">
            <InputText id="email" class="form-control" placeholder="Email" @bind-Value="forgotModel.Email" />
            <label for="email">Email</label>
            <ValidationMessage For="@(() => forgotModel.Email)" />
        </div>

        <button type="submit" class="btn btn-dark rounded-pill w-100 fw-bold py-2 mb-3">Next</button>
    </EditForm>
}
else
{
    <div class="text-center">
        <div class="mb-4">
            <i class="bi bi-envelope-check-fill text-success fs-1"></i>
        </div>
        <h5 class="fw-bold">Check your email</h5>
        <p class="text-muted mb-4">We've sent a password reset link to <strong>@forgotModel.Email</strong></p>
        
        <!-- Simulation for Development -->
        <div class="alert alert-info small text-break text-start">
            <strong>[DEV ONLY] Simulated Email Link:</strong><br/>
            <a href="@simulatedLink">@simulatedLink</a>
        </div>
    </div>
}

<div class="mt-4 text-center">
    <a href="/login" class="text-decoration-none fw-bold text-secondary">Back to Login</a>
</div>

@code {
    private ForgotPasswordModel forgotModel = new();
    private string errorMessage = string.Empty;
    private bool emailSent = false;
    private string simulatedLink = string.Empty;

    private async Task HandleSubmit()
    {
        errorMessage = string.Empty;
        
        // Generate Token
        var token = await UserService.GeneratePasswordResetToken(forgotModel.Email);
        
        if (token != null)
        {
            emailSent = true;
            // Create the link (In production, email this)
            var uri = NavigationManager.BaseUri;
            simulatedLink = $"{uri}reset-password/{token}";
        }
        else
        {
            // Security: Ideally don't reveal if email exists, but for now:
            errorMessage = "We couldn't find an account with that email.";
        }
    }

    public class ForgotPasswordModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;
    }
}