@page "/profile"
@page "/profile/{UserId:int?}"
@inject UserService UserService
@inject PostService PostService
@inject AuthenticationStateProvider AuthStateProvider
@using LitePost.Data.Models
@using System.ComponentModel.DataAnnotations

@if (user == null)
{
    <div class="d-flex justify-content-center mt-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="card mb-3 border-0">
        <div class="position-relative">
            <div class="bg-secondary" style="height: 150px;"></div> <!-- Banner placeholder -->
            <img src="@(user.AvatarUrl ?? "https://github.com/mdo.png")" alt="@user.Username" width="100" height="100" class="rounded-circle border border-4 border-white position-absolute start-0 bottom-0 ms-3 mb-3 bg-white">
        </div>
        <div class="card-body pt-5 mt-3">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h4 class="fw-bold mb-0">@user.DisplayName</h4>
                    @if (user.IsVerified)
                    {
                        <i class="bi bi-patch-check-fill text-primary ms-1" title="Verified"></i>
                    }
                    <div class="text-muted">@@@user.Username</div>
                </div>
                <div>
                    @if (isCurrentUser)
                    {
                        <button class="btn btn-outline-secondary rounded-pill fw-bold" @onclick="OpenEditModal">Edit Profile</button>
                    }
                    else
                    {
                        <button class="btn btn-dark rounded-pill fw-bold px-4" @onclick="ToggleFollow">
                            @(isFollowing ? "Following" : "Follow")
                        </button>
                        <button class="btn btn-outline-secondary rounded-circle ms-2"><i class="bi bi-bell"></i></button>
                        <button class="btn btn-outline-secondary rounded-circle ms-2"><i class="bi bi-envelope"></i></button>
                    }
                </div>
            </div>

            <p class="mt-3">@user.Bio</p>

            <div class="d-flex mb-3">
                <div class="me-3">
                    <span class="fw-bold text-dark">@(user.Following?.Count ?? 0)</span> <span class="text-muted">Following</span>
                </div>
                <div>
                    <span class="fw-bold text-dark">@(user.Followers?.Count ?? 0)</span> <span class="text-muted">Followers</span>
                </div>
            </div>

            <ul class="nav nav-tabs nav-fill mb-3">
                <li class="nav-item">
                    <a class="nav-link active fw-bold" href="#">Posts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted fw-bold" href="#">Replies</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted fw-bold" href="#">Media</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted fw-bold" href="#">Likes</a>
                </li>
            </ul>

            @if (posts != null)
            {
                @foreach (var post in posts)
                {
                    <PostItem Post="@post" OnLike="LikePost" />
                }
            }
        </div>
    </div>

    <!-- Edit Profile Modal -->
    @if (showEditModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold">Edit profile</h5>
                        <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@editModel" OnValidSubmit="SaveProfile">
                            <DataAnnotationsValidator />
                            
                            <div class="position-relative mb-5">
                                <div class="bg-secondary rounded" style="height: 100px;"></div>
                                <div class="position-absolute start-0 bottom-0 translate-middle-y ms-3">
                                    <div class="position-relative d-inline-block">
                                        <img src="@(string.IsNullOrEmpty(editModel.AvatarUrl) ? "https://github.com/mdo.png" : editModel.AvatarUrl)" 
                                             width="80" height="80" class="rounded-circle border border-4 border-white bg-white">
                                        <div class="position-absolute top-50 start-50 translate-middle">
                                            <i class="bi bi-camera-fill text-white fs-4" style="text-shadow: 0 0 4px rgba(0,0,0,0.5);"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-floating mb-3 pt-4">
                                <InputText id="displayName" class="form-control" @bind-Value="editModel.DisplayName" placeholder="Name" />
                                <label for="displayName">Name</label>
                                <ValidationMessage For="@(() => editModel.DisplayName)" />
                            </div>
                            
                            <div class="form-floating mb-3 pt-4">
                                <InputText id="displayEmail" class="form-control" @bind-Value="editModel.Email" placeholder="Email" />
                                <label for="displayEmail">Email</label>
                                <ValidationMessage For="@(() => editModel.Email)" />
                            </div>

                            <div class="form-floating mb-3">
                                <InputTextArea id="bio" class="form-control" @bind-Value="editModel.Bio" placeholder="Bio" style="height: 100px" />
                                <label for="bio">Bio</label>
                                <ValidationMessage For="@(() => editModel.Bio)" />
                            </div>

                             <div class="form-floating mb-3">
                                <InputText id="avatarUrl" class="form-control" @bind-Value="editModel.AvatarUrl" placeholder="Avatar URL" />
                                <label for="avatarUrl">Avatar URL (Image Link)</label>
                                <ValidationMessage For="@(() => editModel.AvatarUrl)" />
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-dark rounded-pill fw-bold px-4">Save</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public int? UserId { get; set; }

    private User? user;
    private List<Post>? posts;
    private bool isCurrentUser;
    private bool isFollowing; 
    private int currentUserId;

    // Edit Modal State
    private bool showEditModal = false;
    private EditProfileModel editModel = new();

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var currentUser = authState.User;

        if (currentUser.Identity != null && currentUser.Identity.IsAuthenticated)
        {
            var idClaim = currentUser.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (idClaim != null)
            {
                currentUserId = int.Parse(idClaim.Value);
            }
        }

        int targetId = UserId ?? currentUserId;
        if (targetId == 0) return; 

        isCurrentUser = (targetId == currentUserId);
        await LoadUserData(targetId);
    }

    private async Task LoadUserData(int userId)
    {
        user = await UserService.GetUser(userId);
        
        if (user != null)
        {
            posts = await PostService.GetPostsByUser(user.Id);
            // Check follow status would be here
        }
    }

    private void OpenEditModal()
    {
        if (user != null)
        {
            editModel = new EditProfileModel
            {
                Email = user.Email,
                DisplayName = user.DisplayName,
                Bio = user.Bio,
                AvatarUrl = user.AvatarUrl
            };
            showEditModal = true;
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
    }

    private async Task SaveProfile()
    {
        if (user != null)
        {
            var success = await UserService.UpdateUserProfile(user.Id, editModel.DisplayName, editModel.Bio, editModel.AvatarUrl, editModel.Email);
            if (success)
            {
                await LoadUserData(user.Id); // Refresh data
                CloseEditModal();
            }
        }
    }

    private void ToggleFollow()
    {
        isFollowing = !isFollowing;
        // Call API to follow/unfollow logic
    }

    private async Task LikePost(int postId)
    {
        await PostService.LikePost(currentUserId, postId);
        if (user != null)
        {
            posts = await PostService.GetPostsByUser(user.Id); // Refresh
        }
    }

    public class EditProfileModel
    {
        [Required(ErrorMessage = "Name cannot be empty")]
        [StringLength(50, ErrorMessage = "Name is too long")]
        public string DisplayName { get; set; } = string.Empty;

        [StringLength(160, ErrorMessage = "Bio cannot exceed 160 characters")]
        public string? Bio { get; set; }
        
        [EmailAddress]
        [StringLength(200, ErrorMessage = "Email cannot exceed 200 characters")]
        public string? Email { get; set; }

        [Url(ErrorMessage = "Please enter a valid URL")]
        public string? AvatarUrl { get; set; }
    }
}