@page "/lists"
@inject ListService ListService
@inject UserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@using LitePost.Data.Models
@using System.ComponentModel.DataAnnotations

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0">Lists</h4>
    <button class="btn btn-outline-primary rounded-pill" @onclick="OpenCreateModal">
        <i class="bi bi-plus-lg"></i> New List
    </button>
</div>

@if (userLists == null)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!userLists.Any() && selectedList == null)
{
    <div class="text-center mt-5">
        <i class="bi bi-list-stars fs-1 text-muted"></i>
        <h3 class="fw-bold mt-3">Pin your favorite Lists</h3>
        <p class="text-muted">Create lists to curate your own feed.</p>
    </div>
}
else
{
    @if (selectedList == null)
    {
        <div class="list-group list-group-flush">
            @foreach (var list in userLists)
            {
                <button class="list-group-item list-group-item-action" @onclick="() => SelectList(list)">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1 fw-bold">@list.Name</h5>
                        <small>@list.Members?.Count members</small>
                    </div>
                    <p class="mb-1 text-muted">@list.Description</p>
                    @if(list.IsPrivate)
                    {
                        <small class="text-muted"><i class="bi bi-lock-fill"></i> Private</small>
                    }
                </button>
            }
        </div>
    }
    else
    {
        <div class="mb-3">
            <button class="btn btn-link text-decoration-none ps-0 mb-3" @onclick="CloseList">
                <i class="bi bi-arrow-left"></i> Back to Lists
            </button>
            <div class="card border-0 bg-light mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="fw-bold mb-0">@selectedList.Name</h3>
                            <p class="text-muted mb-2">@selectedList.Description</p>
                            <small class="text-muted">@selectedList.Members?.Count members</small>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" @onclick="DeleteList">Delete List</button>
                    </div>
                    
                    <div class="mt-3">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" placeholder="Add user by username" @bind="newMemberUsername" />
                            <button class="btn btn-outline-secondary" type="button" @onclick="AddMember">Add</button>
                        </div>
                        @if (!string.IsNullOrEmpty(addMemberError))
                        {
                            <div class="text-danger small">@addMemberError</div>
                        }
                    </div>
                </div>
            </div>
            
            <h5 class="fw-bold mb-3">List Feed</h5>
            @if (listPosts == null)
            {
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            }
            else if (!listPosts.Any())
            {
                 <div class="text-center p-5 text-muted">
                    No posts from members in this list yet.
                </div>
            }
            else
            {
                @foreach (var post in listPosts)
                {
                    <PostItem Post="@post" />
                }
            }
        </div>
    }
}

@if (showCreateModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Create a new List</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@newListModel" OnValidSubmit="CreateList">
                        <DataAnnotationsValidator />
                        
                        <div class="form-floating mb-3 pt-2">
                            <InputText id="listName" class="form-control" @bind-Value="newListModel.Name" placeholder="Name" />
                            <label for="listName">Name</label>
                            <ValidationMessage For="@(() => newListModel.Name)" />
                        </div>

                        <div class="form-floating mb-3">
                            <InputTextArea id="listDesc" class="form-control" @bind-Value="newListModel.Description" placeholder="Description" style="height: 100px" />
                            <label for="listDesc">Description</label>
                            <ValidationMessage For="@(() => newListModel.Description)" />
                        </div>

                        <div class="form-check mb-3">
                            <InputCheckbox id="isPrivate" class="form-check-input" @bind-Value="newListModel.IsPrivate" />
                            <label class="form-check-label" for="isPrivate">Make Private</label>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-dark rounded-pill fw-bold px-4">Create</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserList>? userLists;
    private UserList? selectedList;
    private List<Post>? listPosts;
    private int currentUserId;
    private bool showCreateModal = false;
    private NewListModel newListModel = new();
    
    private string newMemberUsername = string.Empty;
    private string addMemberError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null)
            {
                currentUserId = int.Parse(userIdClaim.Value);
                await LoadLists();
            }
        }
    }

    private async Task LoadLists()
    {
        userLists = await ListService.GetUserLists(currentUserId);
    }

    private void OpenCreateModal() => showCreateModal = true;
    private void CloseCreateModal() => showCreateModal = false;

    private async Task SelectList(UserList list)
    {
        selectedList = list;
        // Refresh list details to get members
        var detailedList = await ListService.GetList(list.Id);
        if(detailedList != null) selectedList = detailedList;

        listPosts = await ListService.GetListFeed(list.Id);
    }

    private void CloseList()
    {
        selectedList = null;
        listPosts = null;
    }

    private async Task CreateList()
    {
        await ListService.CreateList(currentUserId, newListModel.Name, newListModel.Description, newListModel.IsPrivate);
        CloseCreateModal();
        newListModel = new(); // Reset form
        await LoadLists();
    }

    private async Task DeleteList()
    {
        if (selectedList != null)
        {
            await ListService.DeleteList(selectedList.Id);
            selectedList = null;
            await LoadLists();
        }
    }

    private async Task AddMember()
    {
        addMemberError = string.Empty;
        if (string.IsNullOrWhiteSpace(newMemberUsername)) return;
        if (selectedList == null) return;

        var userToAdd = await UserService.GetUserByUsername(newMemberUsername);
        if (userToAdd == null)
        {
            addMemberError = "User not found.";
            return;
        }

        if (selectedList.Members.Any(m => m.UserId == userToAdd.Id))
        {
            addMemberError = "User already in list.";
            return;
        }

        await ListService.AddMember(selectedList.Id, userToAdd.Id);
        newMemberUsername = string.Empty;
        
        // Refresh
        await SelectList(selectedList);
    }

    public class NewListModel
    {
        [Required]
        [StringLength(50, ErrorMessage = "Name is too long.")]
        public string Name { get; set; } = string.Empty;

        [StringLength(200, ErrorMessage = "Description is too long.")]
        public string? Description { get; set; }

        public bool IsPrivate { get; set; }
    }
}