@page "/reset-password/{Token}"
@layout AuthLayout
@inject UserService UserService
@inject NavigationManager NavigationManager
@using System.ComponentModel.DataAnnotations
@using LitePost.Shared

<h3 class="fw-bold mb-4">Reset your password</h3>

@if (isValidToken)
{
    @if (!isSuccess)
    {
        <EditForm Model="@resetModel" OnValidSubmit="HandleReset">
            <DataAnnotationsValidator />
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger py-2 mb-3 small">@errorMessage</div>
            }
            
            <p class="text-muted small mb-4">Create a new, strong password that you don't use for other websites.</p>

            <div class="form-floating mb-3">
                <InputText id="newPassword" type="password" class="form-control" placeholder="New Password" @bind-Value="resetModel.NewPassword" />
                <label for="newPassword">New Password</label>
                <ValidationMessage For="@(() => resetModel.NewPassword)" />
            </div>
            
            <div class="form-floating mb-4">
                <InputText id="confirmPassword" type="password" class="form-control" placeholder="Confirm Password" @bind-Value="resetModel.ConfirmPassword" />
                <label for="confirmPassword">Confirm Password</label>
                <ValidationMessage For="@(() => resetModel.ConfirmPassword)" />
            </div>

            <button type="submit" class="btn btn-dark rounded-pill w-100 fw-bold py-2 mb-3">Reset Password</button>
        </EditForm>
    }
    else
    {
        <div class="text-center">
            <div class="mb-4">
                <i class="bi bi-check-circle-fill text-success fs-1"></i>
            </div>
            <h5 class="fw-bold">All set!</h5>
            <p class="text-muted mb-4">Your password has been reset successfully.</p>
            <a href="/login" class="btn btn-primary rounded-pill w-100 fw-bold py-2">Go to Login</a>
        </div>
    }
}
else
{
    <div class="alert alert-danger text-center">
        <h5 class="fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Invalid or Expired Token</h5>
        <p>This password reset link is invalid or has expired.</p>
        <a href="/forgot-password" class="btn btn-outline-secondary rounded-pill fw-bold">Request a new one</a>
    </div>
}

<div class="mt-4 text-center">
    <a href="/login" class="text-decoration-none fw-bold text-secondary">Back to Login</a>
</div>

@code {
    [Parameter]
    public string Token { get; set; } = string.Empty;

    private ResetPasswordModel resetModel = new();
    private string errorMessage = string.Empty;
    private bool isValidToken = false;
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        // Validate Token immediately
        if (!string.IsNullOrEmpty(Token))
        {
            isValidToken = await UserService.ValidateResetToken(Token);
        }
    }

    private async Task HandleReset()
    {
        errorMessage = string.Empty;
        
        var success = await UserService.ResetPasswordWithToken(Token, resetModel.NewPassword);
        
        if (success)
        {
            isSuccess = true;
        }
        else
        {
            errorMessage = "Failed to reset password. The link might have expired.";
            isValidToken = false; // Re-check validity state
        }
    }

    public class ResetPasswordModel
    {
        [Required]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters.")]
        public string NewPassword { get; set; } = string.Empty;

        [Required]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}